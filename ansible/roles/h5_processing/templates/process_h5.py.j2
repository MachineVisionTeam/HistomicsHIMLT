#!/usr/bin/env python3
"""
H5 File Processing Script for HIMLT
Auto-generated by Ansible on {{ ansible_date_time.iso8601 }}

This script processes H5 files and imports nuclei boundary data into MySQL.

Usage:
    python process_h5.py --input /path/to/file.h5 --output boundary.txt
    python process_h5.py --input /path/to/file.h5 --import-db
"""

import argparse
import h5py
import mysql.connector
from pathlib import Path
import sys
import logging

# Configuration from Ansible
DB_CONFIG = {
    'host': '{{ db_host }}',
    'port': {{ db_port }},
    'database': '{{ db_name }}',
    'user': '{{ db_user }}',
    'password': '{{ db_password }}'
}

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


def read_h5_file(h5_path):
    """
    Read H5 file and extract nuclei boundary data.
    
    Returns: List of tuples (slide_name, x_centroid, y_centroid, boundary)
    """
    logger.info(f"Reading H5 file: {h5_path}")
    data = []
    
    try:
        with h5py.File(h5_path, 'r') as f:
            # Adjust these keys based on your H5 file structure
            slides = f.keys()
            
            for slide_name in slides:
                slide_group = f[slide_name]
                
                # Extract data (adjust keys as needed)
                x_coords = slide_group.get('x_centroid', [])
                y_coords = slide_group.get('y_centroid', [])
                boundaries = slide_group.get('boundary', [])
                
                for i in range(len(x_coords)):
                    data.append((
                        slide_name,
                        float(x_coords[i]),
                        float(y_coords[i]),
                        str(boundaries[i]) if i < len(boundaries) else ''
                    ))
        
        logger.info(f"Extracted {len(data)} nuclei records")
        return data
        
    except Exception as e:
        logger.error(f"Error reading H5 file: {e}")
        sys.exit(1)


def write_to_file(data, output_path):
    """Write extracted data to tab-separated text file."""
    logger.info(f"Writing data to: {output_path}")
    
    try:
        with open(output_path, 'w') as f:
            for slide, x, y, boundary in data:
                f.write(f"{slide}\t{x}\t{y}\t{boundary}\n")
        
        logger.info(f"Successfully wrote {len(data)} records to {output_path}")
        
    except Exception as e:
        logger.error(f"Error writing file: {e}")
        sys.exit(1)


def import_to_database(data):
    """Import data directly to MySQL database."""
    logger.info("Importing data to database...")
    
    try:
        conn = mysql.connector.connect(**DB_CONFIG)
        cursor = conn.cursor()
        
        # Insert data
        insert_query = """
            INSERT INTO nuclei_boundary (slide, x, y, boundary)
            VALUES (%s, %s, %s, %s)
        """
        
        cursor.executemany(insert_query, data)
        conn.commit()
        
        logger.info(f"Successfully imported {cursor.rowcount} records to database")
        
        cursor.close()
        conn.close()
        
    except mysql.connector.Error as e:
        logger.error(f"Database error: {e}")
        sys.exit(1)


def main():
    parser = argparse.ArgumentParser(description='Process H5 files for HIMLT')
    parser.add_argument('--input', required=True, help='Path to input H5 file')
    parser.add_argument('--output', help='Path to output text file (if not importing to DB)')
    parser.add_argument('--import-db', action='store_true', help='Import directly to database')
    
    args = parser.parse_args()
    
    # Validate input file
    input_path = Path(args.input)
    if not input_path.exists():
        logger.error(f"Input file not found: {args.input}")
        sys.exit(1)
    
    # Read H5 file
    data = read_h5_file(input_path)
    
    # Output or import
    if args.import_db:
        import_to_database(data)
    else:
        if not args.output:
            output_path = input_path.parent / 'boundary.txt'
        else:
            output_path = Path(args.output)
        
        write_to_file(data, output_path)
        logger.info("\nTo import this file to database, run:")
        logger.info(f"  mysql -u {{ db_user }} -p {{ db_name }} < {output_path}")


if __name__ == '__main__':
    main()
